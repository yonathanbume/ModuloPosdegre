var InitApp=function(){var t={payments:{object:null,options:{data:{source:{read:{method:"GET",url:null}}},columns:[{field:"type",title:"Tipo",width:100,template:function(t){return`<span class="m-badge m-badge--brand m-badge--wide">${t.type}</span> <input hidden name="Type" value="${t.type}" />`}},{field:"concept",title:"Concepto"},{field:"issueDate",title:"Fecha emisión"},{field:"totalamount",title:"Monto Total",textAlign:"right",template:function(t){return"S/. "+t.totalamount.toFixed(2)}},{field:"user",title:"Creado por"},{field:"option",title:" ",width:50,template:function(t){return t.isCreator?`<button type="button" class="btn btn-danger m-btn btn-sm m-btn--icon m-btn--icon-only btn-delete" data-id="${t.id}"><i class="la la-trash"></i></button>`:""}}]},load:function(e){$("#empty-message").hide(),$("#btn-new").show(),void 0!==t.payments.object&&$.trim($(".m-datatable").html()).length&&t.payments.object.destroy(),t.payments.options.data.source.read.url=`/admin/gestor-de-deudas/usuario/${e}/pendientes/get`.proto().parseURL(),t.payments.object=$("#ajax_data").mDatatable(t.payments.options),$("#ajax_data").on("click",".btn-delete",(function(e){var a=$(this).data("id");swal({title:"¿Está seguro?",text:"Se eliminará el pago pendiente del usuario",type:"warning",showCancelButton:!0,confirmButtonText:"Sí, eliminarlo",confirmButtonClass:"btn btn-danger m-btn m-btn--custom",cancelButtonText:"Cancelar"}).then((function(e){e.value&&$.ajax({url:"/admin/gestor-de-deudas/usuario/conceptos/eliminar",type:"POST",data:{id:a},success:function(){t.payments.object.reload(),toastr.success(_app.constants.toastr.message.success.task,_app.constants.toastr.title.success)},error:function(){toastr.error(_app.constants.toastr.message.error.task,_app.constants.toastr.title.error)}})}))}))},destroy:function(){void 0!==t.payments.object&&$.trim($(".m-datatable").html()).length&&t.payments.object.destroy(),$("#empty-message").show(),$("#btn-new").hide()}},concepts:{object:null,options:{serverSide:!0,ajax:{url:"/admin/gestor-de-deudas/conceptos/get".proto().parseURL(),type:"GET",dataType:"JSON",data:function(t){delete t.columns,t.search=$("#search2").val()}},pageLength:8,orderable:[],columns:[{title:"Cuenta",width:80,data:"classifier"},{title:"Código",width:50,data:"code"},{title:"Descripción",data:"description"},{title:"Monto",width:70,className:"text-right",data:"amount",render:function(t){return"S/. "+t.toFixed(2)}},{data:null,width:50,orderable:!1,render:function(t){return`<div class="table-options-section">\n                                <button data-description="${t.description}" data-id="${t.id}" class="btn btn-info btn-sm m-btn m-btn--icon m-btn--icon-only btn-confirmation" title=""><i class="la la-plus"></i></button>\n                            </div>`}}]},init:function(){this.object=$("#concept-table").DataTable(this.options),$("#concept-table").on("click",".btn-confirmation",(function(e){var a=$(this).data("id"),n=$(this).data("description");t.concepts.confirmation(a,n)}))},reload:function(){this.object.ajax.reload()},confirmation:function(e,a){swal({confirmButtonText:"Si",input:"text",inputValue:a,inputAttributes:{autocapitalize:"off"},inputValidator:t=>{if(!t)return"Debes especificar una descripción"},cancelButtonText:"No",showCancelButton:!0,title:"¿Desea generar el pago del concepto?",text:"Se iniciará la solicitud del concepto seleccionado.Modifique el campo si así lo desea.",type:"warning",showLoaderOnConfirm:!0,preConfirm:a=>new Promise((n=>{console.log(a),$.ajax({url:`/admin/gestor-de-deudas/usuario/${$("#user").val()}/conceptos/registrar`.proto().parseURL(),type:"POST",data:{conceptId:e,description:a},success:function(){toastr.success(_app.constants.toastr.message.success.task,_app.constants.toastr.title.success),$("#concept_modal").modal("hide"),$("#ajax_data").one("m-datatable--on-layout-updated",(function(){$("[name='Payments']:last").click()})),t.payments.object.reload()},error:function(t){toastr.error(_app.constants.toastr.message.error.task,_app.constants.toastr.title.error)},complete:function(){swal.close()}})})),allowOutsideClick:()=>swal.isLoading()})}},exonerated:{object:null,options:{serverSide:!0,filter:!1,lengthChange:!1,ajax:{url:`/admin/gestor-de-deudas/usuario/${$("#code").val()}/exonerados/get`.proto().parseURL(),type:"GET",dataType:"JSON",data:function(t){t.searchValue=$("#search").val()}},pageLength:10,orderable:[],columns:[{title:"Tipo",data:"type"},{title:"Concepto",data:"concept"},{title:"Fecha Emisión",data:"issueDate"},{title:"Fecha de Exoneración",data:"paymentDate"},{title:"Monto Total",data:null,render:function(t){return"S/. "+t.totalamount.toFixed(2)}}]},load:function(t){this.options.ajax.url=`/admin/gestor-de-deudas/usuario/${t}/exonerados/get`.proto().parseURL(),null!=this.object&&this.object.destroy(),this.object=$("#exonerated-data-table").DataTable(this.options)},reload:function(){this.object.ajax.reload()}},init:function(){}},e={validate:function(){var e=$("#code_user").val();if(""===e)return t.payments.destroy(),$("#info-portlet").addClass("m--hide"),void swal("Debe ingresar un usuario","Debe ingresar un código de usuario primero.","warning");mApp.blockPage(),$.ajax({type:"GET",url:`/admin/gestor-de-deudas/usuario/${e}/valida`.proto().parseURL()}).done((function(a){$("#user").val(e),t.payments.load(e),t.exonerated.load(e),$("#info-portlet").removeClass("m--hide"),$("#code").val(a.code),$("#fullname").val(a.name),$("#dni").val(a.dni),$("#user-code").val(e)})).fail((function(){t.payments.destroy(),$("#info-portlet").addClass("m--hide"),swal("Usuario incorrecto","El código de usuario ingresado no existe.","error")})).always((function(){mApp.unblockPage()}))},init:function(){$("#code_search").on("click",(function(){e.validate()})),$("#code_user").on("keypress",(function(t){13===t.keyCode&&e.validate()}))}},a=function(){$("#search2").doneTyping((function(){t.concepts.reload()})),$("#concept_modal").on("shown.bs.modal",(function(){$(document).off("focusin.modal")})),$("#concept_modal").on("shown.bs.modal",(function(t){$("#concept-select").val(null).trigger("change")}))},n={search:{init:function(){$("#user-select").select2({dropdownParent:$("#users_modal"),width:"100%",placeholder:"Buscar...",ajax:{url:"/admin/gestor-de-deudas/buscar".proto().parseURL(),dataType:"json",data:function(t){return{term:t.term,page:t.page}},processResults:function(t,e){return{results:t.items}},cache:!0},escapeMarkup:function(t){return t},minimumInputLength:3}),$("#btn-user").on("click",(function(){n.search.load()}))},load:function(){var t=$("#user-select").val();if(""===t)return swal("Seleccione un usuario","Debe buscar y seleccionar un usuario primero","warning"),!1;$("#users_modal").modal("hide"),$("#code_user").val(t),$("#user-code").val(t),e.validate()}},concepts:{init:function(){$("#concept-select").select2({width:"100%",placeholder:"Buscar...",ajax:{delay:1e3,url:"/conceptos/buscar".proto().parseURL(),dataType:"json",data:function(t){return{term:t.term,page:t.page}},processResults:function(t){return{results:$.map(t.items,(function(t){return{text:t.text,accountingplan:t.accountingplan,fixed:t.isFixed,taxed:t.isTaxed,price:t.price,id:t.id,accountId:t.accountId}}))}},cache:!0},escapeMarkup:function(t){return t},minimumInputLength:3}),$("#concept-select").change((function(){var t=$("#concept-select").val();if(console.log(t),null!=t&&""!=t){var e=$(this).select2("data");$("#concept-id").val(e[0].id),$("#concept-name").val(e[0].text),$("#concept-price").val(e[0].price)}}))}}},o={create:{object:$("#concept-form").validate({submitHandler:function(e){mApp.block("#concept_modal .modal-content"),$.ajax({url:$(e).attr("action"),type:"POST",data:$(e).serialize()}).done((function(){$(".modal").modal("hide"),$(".m-alert").addClass("m--hide"),toastr.success(_app.constants.toastr.message.success.task,_app.constants.toastr.title.success),t.payments.object.reload();var e=$("#user-code").val();o.create.clear(),$("#user-code").val(e)})).fail((function(t){null!==t.responseText&&""!==t.responseText?$("#create-alert-txt").html(t.responseText):$("#create-alert-txt").html(_app.constants.ajax.message.error),$("#create-alert").removeClass("m--hide").show()})).always((function(){mApp.unblock("#concept_modal .modal-content")}))}}),clear:function(){this.object.resetForm(),$("#concept-select").val(null).trigger("change")}}};return{init:function(){e.init(),t.init(),a(),n.search.init(),n.concepts.init()},adjustConcepts:function(){}}}();$((function(){InitApp.init()}));