var InitApp=function(){var t=null,e={history:{object:null,optionsIntegrated:{serverSide:!1,ajax:{url:"/registrosacademicos/solicitudes/get-historial",type:"GET",data:function(t){delete t.columns,t.studentId=$("#student_select").val(),t.type=$("#type_select").val(),t.academicrecordId=$("#academic_record_select").val()}},pageLength:50,orderable:[],columns:[{title:"Fecha emisión",data:"date"},{title:"Nro. constancia",data:"number"},{title:"Tipo de Constancia",data:"type"},{title:"Trámite Asociado",data:"userProcedure"},{title:"Estado",data:"status"},{title:"Opciones",data:null,render:function(t){var e="";return t.isTypeBachelor?e+=`<a href='/registrosacademicos/informes-de-grados/creacion-informe-grados/${t.username}/${t.id}' class='btn btn-secondary btn-sm m-btn--icon btn-grade'>Generar informe</a>`:t.isTypeJobTitle?e+=`<a href='/registrosacademicos/informes-de-titulos/creacion-informe-titulo/${t.username}/${t.id}' class='btn btn-secondary btn-sm m-btn--icon btn-grade'>Generar informe</a>`:(t.withProcedure||(e+=`<button data-id='${t.id}' type='button' class="btn btn-change-status btn-secondary m-btn m-btn--icon btn-sm m-btn--icon-only" title='Editar'><i class="la la-edit"></i></button>`),e+="<button data-id='"+t.id+"' class='ml-1 btn btn-secondary btn-sm m-btn--icon btn-print'><i class='la la-print'></i></button>"),e}}]},options:{serverSide:!1,ajax:{url:"/registrosacademicos/solicitudes/get-historial",type:"GET",data:function(t){delete t.columns,t.studentId=$("#student_select").val(),t.type=$("#type_select").val(),t.academicrecordId=$("#academic_record_select").val()}},pageLength:50,orderable:[],columns:[{title:"Fecha emisión",data:"date"},{title:"Nro. constancia",data:"number"},{title:"Tipo de Constancia",data:"type"},{title:"Estado",data:"status"},{title:"Opciones",data:null,render:function(t){var e="";return t.isTypeBachelor?e+=`<a href='/registrosacademicos/informes-de-grados/creacion-informe-grados/${t.username}/${t.id}' class='btn btn-secondary btn-sm m-btn--icon btn-grade'>Generar informe</a>`:t.isTypeJobTitle?e+=`<a href='/registrosacademicos/informes-de-titulos/creacion-informe-titulo/${t.username}/${t.id}' class='btn btn-secondary btn-sm m-btn--icon btn-grade'>Generar informe</a>`:(t.withProcedure||(e+=`<button data-id='${t.id}' type='button' class="btn btn-change-status btn-secondary m-btn m-btn--icon btn-sm m-btn--icon-only" title='Editar'><i class="la la-edit"></i></button>`),e+="<button data-id='"+t.id+"' class='ml-1 btn btn-secondary btn-sm m-btn--icon btn-print'><i class='la la-print'></i></button>"),e}}]},reload:function(){null!==this.object?this.object.ajax.reload():IsIntegrated?this.object=$("#data-table").DataTable(this.optionsIntegrated):this.object=$("#data-table").DataTable(this.options)},events:{onChangeStatus:function(){$("#data-table").on("click",".btn-change-status",(function(){var t=$(this).data("id");o.changeStatus.events.show(t)})),$("#data-table").on("click",".btn-need-data",(function(){var t=$(this).data("id");o.needData.events.show(t)}))},onViewObservations:function(){$("#data-table").on("click",".btn-observations",(function(){var t=$(this).data("id");o.viewObservation.events.show(t)}))},onPrint:function(){$("#data-table").on("click",".btn-print",(function(){var t=$(this),a=`/registrosacademicos/solicitudes/imprimir/${$(this).data("id")}`;t.addLoader(),$.fileDownload(a,{httpMethod:"GET",successCallback:function(){t.removeLoader(),toastr.success("Archivo descargado satisfactoriamente","Éxito"),e.reports.reload()},failCallback:function(e,a){t.removeLoader(),e=(e=e.replace('<pre style="word-wrap: break-word; white-space: pre-wrap;">',"")).replace("</pre>",""),toastr.error(e,"Error")}})})),$("#data-table").on("click",".btn-need-data",(function(){var t=$(this).data("id");o.needData.events.show(t)}))},onReceipt:function(){$("#data-table").on("click",".btn-receipt",(function(){var t=$(this).data("id");$("#receipt_recordHistoryId").val(t),$("#receipt_modal").modal("show")}))},init:function(){this.onChangeStatus(),this.onViewObservations(),this.onPrint()}},init:function(){this.events.init()}},observations:{object:null,options:{ajax:{url:"/registrosacademicos/solicitudes/get-observaciones",type:"GET",data:function(e){e.recordHistoryId=t}},columns:[{data:"date",title:"Fecha",orderable:!1},{data:"status",title:"Estado",orderable:!1},{data:"observation",title:"Observaciones",orderable:!1}]},reload:function(){null===e.observations.object?e.observations.object=$("#table_observations").DataTable(e.observations.options):e.observations.object.ajax.reload()}},init:function(){this.history.init()}},a={student_select:{load:function(){$("#student_select").select2({placeholder:"Buscar...",ajax:{delay:500,url:"/alumnosv2/get".proto().parseURL(),data:function(t){return{searchValue:t.term,page:t.page||1}}},minimumInputLength:3})},onChange:function(){$("#student_select").on("change",(function(){var t=$(this).val();a.userProcedure.load(t),a.term.load(t)}))},init:function(){this.load(),this.onChange()}},userProcedure:{load:function(t){$.ajax({url:`/registrosacademicos/solicitudes/tramites-asociados?studentId=${t}`,type:"GET"}).done((function(t){$("#user_procedures").empty(),$("#user_procedures").select2({placeholder:"Seleccionar trámite",data:t,disabled:!1,allowClear:!0}),$("#user_procedures").val(null).trigger("change")}))},init:function(){$("#user_procedures").select2({placeholder:"Seleccionar trámite",disabled:!0})}},type:{load:function(){$.ajax({url:"/tipos-contancias/get",type:"GET"}).done((function(t){$("#type_select").select2({placeholder:"Seleccionar tipo de constancia",data:t.items})}))},onChange:function(){$("#type_select").on("change",(function(){18!=$(this).val()||""!=$("#student_select").val()&&null!=$("#student_select").val()?18==$(this).val()&&""!=$("#student_select").val()&&null!=$("#student_select").val()||11==$(this).val()&&""!=$("#student_select").val()&&null!=$("#student_select").val()||13==$(this).val()&&""!=$("#student_select").val()&&null!=$("#student_select").val()||30==$(this).val()&&""!=$("#student_select").val()&&null!=$("#student_select").val()||31==$(this).val()&&""!=$("#student_select").val()&&null!=$("#student_select").val()||5==$(this).val()&&""!=$("#student_select").val()&&null!=$("#student_select").val()||33==$(this).val()&&""!=$("#student_select").val()&&null!=$("#student_select").val()?($("#row_certificatestudies_partial").addClass("d-none"),$("#div_select_term").removeClass("d-none")):25==$(this).val()?($("#row_certificatestudies_partial").removeClass("d-none"),$("#div_select_term").addClass("d-none"),a.certificatePartial.range.load()):($("#row_certificatestudies_partial").addClass("d-none"),$("#div_select_term").addClass("d-none")):($("#row_certificatestudies_partial").addClass("d-none"),$("#div_select_term").removeClass("d-none"))}))},init:function(){this.load(),this.onChange()}},term:{load:function(t){$.ajax({url:`/periodos-por-estudiante/get/v3?studentId=${t}`,type:"GET"}).done((function(t){$("#term_select").empty(),$("#term_select").select2({placeholder:"Seleccionar tipo de constancia",data:t.items,disabled:!1})}))},init:function(){$("#term_select").select2({placeholder:"Seleccionar periodo",disabled:!0})}},status:{init:function(){$("[name='Status']").select2({minimumResultsForSearch:-1})}},certificatePartial:{rangeType:{load:function(){$("#range_type_select").select2({placeholder:"Seleccionar tipo",minimumResultsForSearch:-1}).on("change",(function(){a.certificatePartial.range.load()}))},init:function(){this.load()}},range:{load:function(){$("#range_type_select").val();var t=$("#student_select").val();$("#academicyear_partial_select").empty(),$.ajax({url:`/ventanilla/solicitudes/get-ciclos-alumno?studentId=${t}`}).done((function(t){var e="";$.each(t,(function(t,a){e+=`<option value="${a.id}">${a.text}</option>`})),$("#academicyear_partial_select").html(e),$("#academicyear_partial_select").selectpicker({actionsBox:!0,selectAllText:"Marcar todos",deselectAllText:"Desmarcar todos",noneSelectedText:"Seleccionar"}),$("#academicyear_partial_select").selectpicker("refresh"),$("#academicyear_partial_select").trigger("change")}))},init:function(){}},init:function(){this.rangeType.init(),this.range.init()}},init:function(){a.student_select.init(),a.type.init(),a.userProcedure.init(),a.term.init(),a.status.init(),a.certificatePartial.init()}},n={onHistory:function(){$("#btn-history").click((function(){if(""===$("#student_select").val()||null===$("#student_select").val())return toastr.error("Es necesario seleccionar al estudiante",_app.constants.toastr.title.error),!1;e.history.reload()}))},onRegister:function(){$("#btn-create").click((function(){var t=$("#type_select").val(),a=$("#student_select").val(),n=$("#term_select").val(),o=$("#user_procedures").val(),i=$("#range_type_select").val(),s=JSON.stringify($("#academicyear_partial_select").val());if(""===a||null===a)return toastr.error("Debe completar todos los campos",_app.constants.toastr.title.error),!1;if(""===t||null===t)return toastr.error("Debe completar todos los campos",_app.constants.toastr.title.error),!1;if(18==t&&(""===n||null===n))return toastr.error("Debe completar todos los campos",_app.constants.toastr.title.error),!1;if(5==t&&(""===n||null===n))return toastr.error("Debe completar todos los campos",_app.constants.toastr.title.error),!1;var r=new FormData;r.append("StudentId",a),r.append("RecordType",t),r.append("UserProcedureId",o),r.append("TermId",n),r.append("RangeType",i),r.append("JsonAcademicYearPartials",s),swal({title:"Generar Documento",text:"¿Seguro que desea generar el documento?",type:"warning",showCancelButton:!0,confirmButtonText:"Sí",confirmButtonClass:"btn btn-danger m-btn m-btn--custom",cancelButtonText:"Cancelar",showLoaderOnConfirm:!0,allowOutsideClick:()=>!swal.isLoading(),preConfirm:()=>new Promise((()=>{$.ajax({url:"/registrosacademicos/solicitudes/generar",type:"POST",data:r,processData:!1,contentType:!1}).done((function(){e.history.reload(),swal({type:"success",title:"Completado",text:"El documento ha sido generado con éxito.",confirmButtonText:"Excelente"})})).fail((function(){swal({type:"error",title:"Error",confirmButtonClass:"btn btn-danger m-btn m-btn--custom",confirmButtonText:"Entendido",text:"Error al generar el documento"})}))}))})}))},init:function(){this.onHistory(),this.onRegister()}},o={changeStatus:{object:$("#change_status_modal"),form:{object:$("#change_status_form").validate({submitHandler:function(t,a){var n=$("#change_status_form").find(".btn-primary");n.addLoader();var i=new FormData($(t)[0]);$.ajax({url:"/registrosacademicos/solicitudes/actualizar-estado",type:"POST",data:i,contentType:!1,processData:!1}).done((function(t){e.history.reload(),o.changeStatus.object.modal("hide"),swal({type:"success",title:"Hecho!",text:"Registro actualizado con éxito.",allowOutsideClick:!1,confirmButtonText:"Aceptar"})})).fail((function(){swal({type:"error",title:"Error",confirmButtonClass:"btn btn-danger m-btn m-btn--custom",confirmButtonText:"Aceptar",text:502===a.status?"No hay respuesta del servidor":a.responseText})})).always((function(){n.removeLoader()}))}})},events:{show:function(t){o.changeStatus.object.find("[name='RecordHistoryId']").val(t),o.changeStatus.object.find(":input").attr("disabled"),o.changeStatus.object.modal("show"),$.ajax({url:`/registrosacademicos/solicitudes/get-record?recordHistoryId=${t}`}).done((function(t){o.changeStatus.object.find("[name='Status']").val(t.status).trigger("change")})).fail((function(t){toastr.error("No se pudo obtener los datos del registro seleccionado","Error")}))},onHidden:function(){o.changeStatus.object.on("hidden.bs.modal",(function(t){o.changeStatus.form.object.resetForm()}))},init:function(){this.onHidden()}},init:function(){this.events.init()}},viewObservation:{object:$("#observation_modal"),events:{show:function(a){t=a,o.viewObservation.object.modal("show"),e.observations.reload()}}},needData:{object:$("#edit_datainfo_modal"),events:{show:function(t){o.needData.object.modal("show"),o.needData.object.find("[name='RecordHistoryId']").val(t),mApp.block("#pdf_preview",{message:"Cargando previsualización..."}),$.ajax({url:`/registrosacademicos/solicitudes/imprimir/${t}?preview=true`,type:"GET"}).done((function(t){$("#preview_pdf_frame").attr("src",`data:application/pdf;base64,${t}`),mApp.unblock("#pdf_preview")}))},onSelect:function(){o.needData.object.find(".btn-automatic").on("click",(function(){var t=`/registrosacademicos/solicitudes/imprimir/${o.needData.object.find("[name='RecordHistoryId']").val()}?withBackground=${$("#with_background").is(":checked")}`;e.history.object.ajax.reload(),o.needData.object.modal("hide"),window.open(t,"_blank")})),o.needData.object.find(".btn-manual").on("click",(function(){var t=o.needData.object.find("[name='RecordHistoryId']").val(),e=($("#with_background").is(":checked"),`/registrosacademicos/solicitudes/guardar-informacion/${t}`);window.location.href=e}))},init:function(){this.onSelect()}},init:function(){this.events.init()}},init:function(){o.changeStatus.init(),o.needData.init()}};return{init:function(){a.init(),n.init(),e.init(),o.init()}}}();$((function(){InitApp.init()}));