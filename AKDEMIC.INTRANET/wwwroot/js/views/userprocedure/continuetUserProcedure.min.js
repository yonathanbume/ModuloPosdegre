var InitApp=function(){var e=[],t="true"==$("#hasReceipt").val().toLowerCase(),a="true"==$("#hasPicture").val().toLowerCase(),n=function(){t?$("#valReceipt").prop("required",!0):$("#valReceipt").prop("required",!1),a?$("#Image").prop("required",!0):$("#Image").prop("required",!1)},s=function(){var e=new Date;e.setDate(e.getDate()),$(".date-picker").datepicker({})},o=function(){$("#createForm").validate({submitHandler:function(e){mApp.blockPage(),e.submit()}})},i={submit:function(t){mApp.block(".m-content",{type:"loader",message:"Cargando"});$(t).serialize();var a=new FormData($(t).get(0));$("#procedure-modal-request-form").find(".btn-submit").addLoader(),$("#procedure-modal-request-form").attr("disabled",!0),e.length>0&&(a.append("PaymentReceipt.Datetime",e[0].datetime),a.append("PaymentReceipt.Sequence",e[0].sequence),a.append("PaymentReceipt.Amount",e[0].amount));for(var n=[],s=0;s<filesAdded.length;s++)filesAdded[s].isdatabase||n.push({file:filesAdded[s].file,name:filesAdded[s].name});for(s=0;s<n.length;s++)a.append("DocumentFiles",n[s].file);$.ajax({type:t.method,url:t.action,data:a,contentType:!1,processData:!1}).done((function(e){window.location.href="/tramites/usuarios?tab=2".proto().parseURL()})).fail((function(e,t,a){var n=e.responseText;""!=n&&400==e.status?toastr.error(n,_app.constants.toastr.title.error):toastr.error(_app.constants.toastr.message.error.task,_app.constants.toastr.title.error),$("#procedure-modal-request-form").attr("disabled",!1),mApp.unblock(".m-content")}))}},r={show:function(){$("#receipt-modal").modal("show"),$("#receipt-modal").one("hidden.bs.modal",(function(){}))},submit:function(t){var a=$(t).serialize();$(t).find("#btnAddReceipt").addLoader(),$(t).find("input").prop("disabled",!0);new FormData($(t).get(0));var n=t.elements;$.ajax({url:$(t).attr("action"),type:"POST",data:a}).always((function(){$(t).find("#btnAddReceipt").removeLoader(),$(t).find("input").prop("disabled",!1)})).done((function(){(e=[]).push({datetime:n.PaymentReceipt_Datetime.value,sequence:n.PaymentReceipt_Sequence.value,amount:n.PaymentReceipt_Amount.value}),$("#valReceipt").html(""),$("#valReceipt").val(`${e[0].datetime}  -  NÂ° ${e[0].sequence}  -  S/. ${e[0].amount}`),toastr.success(_app.constants.toastr.message.success.task,_app.constants.toastr.title.success),$("#receipt-modal").modal("hide"),$("#add_reference_msg").addClass("m--hide").hide()})).fail((function(e){toastr.error(e.responseText,_app.constants.toastr.title.error),null!=e.responseText?$("#add_form_msg_txt").html(e.responseText):$("#add_form_msg_txt").html(_app.constants.ajax.message.error),$("#add_reference_msg").removeClass("m--hide").show()}))}},c={show:function(){$("#image-modal").modal("show"),$("#image-modal").one("hidden.bs.modal",(function(){}))},save:function(){$("#btnCropSave").addLoader(),$("#btnAddReceipt").removeLoader(),toastr.success(_app.constants.toastr.message.success.task,_app.constants.toastr.title.success),$("#image-modal").modal("hide")}},l=function(){$("#Image").on("change",(function(){var e=new FileReader;e.onload=function(e){var t=$("#img-offi")[0],a=$(".cropper-container cropper-bg").prevObject;$("#upload-offi div").remove();var n=new Cropper(t);n.destroy(),n.reset(),n.clear(),n=null,a.remove(),$(".preview").css({width:"100%",overflow:"hidden",height:300,maxWidth:300,maxHeight:300}),$("#img-offi").attr("src",e.target.result),$("#cropper-hide").attr("src",e.target.result),n=new Cropper(t,{dragMode:"move",preview:".preview",aspectRatio:1,minContainerWidth:300,maxContainerWidth:300,minContainerHeight:300,maxContainerHeight:300,background:!1,viewMode:1,aspectRatio:1,responsive:!0,autoCrop:!0,ready:function(){$("#crop_button").trigger("click")}}),$("#btnCropSave").on("click",(function(){$("#btnCropSave").addLoader();var e=n.getCroppedCanvas().toDataURL("image/png");toastr.success(_app.constants.toastr.message.success.task,_app.constants.toastr.title.success),$("#image-modal").modal("hide"),$("#imageFile").prop("required",!1),$("#img-offi-preview").attr("src",e),$("#urlCropImg").val(e),$("#btnCropSave").removeLoader()}))},$("#Image").next().html("Reemplazar imagen"),e.readAsDataURL(this.files[0])}))},d=function(){$(".btn-receipt").on("click",(function(){r.show()})),$(".btn-image").on("click",(function(){c.show()}))},m=function(){$("#procedure-modal-request-form").validate({submitHandler:function(e,t){t.preventDefault(),i.submit(e)}}),$("#create-receipt-form").validate({submitHandler:function(e,t){t.preventDefault(),r.submit(e)}})};return{init:function(){s(),m(),d(),o(),l(),n()}}}(),filesAdded=[],deletedFiles=[],filesTable=function(){var e={objects:{}},t={serverSide:!1,processing:!1,lengthChange:!1,lengthMenu:[5],columnDefs:[{orderable:!1,targets:[2]}],data:e.objects["lst-files"],columns:[{data:"name"},{data:null,render:function(e){var t=e.size;return _app.modules.file.getFormattedFileSize(t)}},{data:null,render:function(e){return`<div class="table-options-section">\n\t\t\t\t\t\t\t\t<button data-id="${e.id}"  data-isdatabase="${e.isdatabase}" data-name="${e.name}" class ="btn btn-danger btn-sm m-btn m-btn--icon btn-delete" title="Eliminar"><i class ="la la-trash"></i></button>\n\t\t\t\t\t\t\t</div>`}}]},a={init:function(){e.objects["lst-files"]=[],e.objects["tbl-files"]=$("#tbl-files").DataTable(t),this.events()},clear:function(){filesAdded=e.objects["lst-files"],e.objects["tbl-files"].clear(),e.objects["tbl-files"].rows.add(e.objects["lst-files"]),e.objects["tbl-files"].draw()},events:function(){e.objects["tbl-files"].on("click",".btn-delete",(function(){var t=$(this).data("id");let n=$(this).data("isdatabase"),s=$(this).data("name");n&&deletedFiles.push({Id:t,name:s});for(var o=-1,i=0;i<e.objects["lst-files"].length;i+=1)if(e.objects["lst-files"][i].id===t){o=i;break}o>-1&&(e.objects["lst-files"].splice(o,1),a.clear(),e.objects["lst-files"].length<1&&($("#DocumentFiles").val(""),$("#DocumentFiles").next().html("Seleccione los documentos")))}))}},n=function(){$("#DocumentFiles").on("change",(function(t){var n=(t.target||window.event.srcElement).files;if(FileReader&&n&&n.length){$.each(n,(function(t,a){e.objects["lst-files"].push({id:t,name:a.name,size:a.size,file:a,isdatabase:!1})})),a.clear(),$("#DocumentFiles").next().html("Documentos seleccionados correctamente")}else a.clear(),$("#DocumentFiles").next().html("Seleccione los documentos")}))};return{init:function(){n(),a.init()}}}();$((function(){InitApp.init(),filesTable.init()}));